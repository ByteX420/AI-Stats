name: npm bootstrap publish

on:
  workflow_dispatch:
    inputs:
      publish_ai_sdk_provider:
        description: "Publish @ai-stats/ai-sdk-provider"
        required: false
        type: boolean
        default: true
      publish_devtools_viewer:
        description: "Publish @ai-stats/devtools-viewer"
        required: false
        type: boolean
        default: true

permissions:
  contents: read

env:
  NODE_VERSION: 22
  NPM_CONFIG_PROVENANCE: true

jobs:
  publish:
    name: Bootstrap publish npm packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.1
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Validate npm bootstrap token
        shell: bash
        env:
          NPM_BOOTSTRAP_TOKEN: ${{ secrets.NPM_BOOTSTRAP_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${NPM_BOOTSTRAP_TOKEN:-}" ]; then
            echo "::error::Missing required secret: NPM_BOOTSTRAP_TOKEN"
            exit 1
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build target packages
        run: |
          pnpm --filter @ai-stats/ai-sdk-provider run build
          pnpm --filter @ai-stats/devtools-viewer run build

      - name: Publish selected packages (skip if version already exists)
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_BOOTSTRAP_TOKEN }}
          PUBLISH_AI_SDK_PROVIDER: ${{ inputs.publish_ai_sdk_provider }}
          PUBLISH_DEVTOOLS_VIEWER: ${{ inputs.publish_devtools_viewer }}
        run: |
          set -euo pipefail

          publish_if_needed () {
            pkg_name="$1"
            pkg_dir="$2"
            pkg_version="$(node -p "require('./${pkg_dir}/package.json').version")"

            if npm view "${pkg_name}@${pkg_version}" version --registry https://registry.npmjs.org >/dev/null 2>&1; then
              echo "skip: ${pkg_name}@${pkg_version} already exists on npm"
              return 0
            fi

            echo "publishing ${pkg_name}@${pkg_version} from ${pkg_dir}"
            (
              cd "${pkg_dir}"
              npm publish --access public
            )
          }

          if [ "${PUBLISH_AI_SDK_PROVIDER}" = "true" ]; then
            publish_if_needed "@ai-stats/ai-sdk-provider" "packages/integrations/ai-sdk-ai-stats"
          fi

          if [ "${PUBLISH_DEVTOOLS_VIEWER}" = "true" ]; then
            publish_if_needed "@ai-stats/devtools-viewer" "packages/devtools/devtools-viewer"
          fi
