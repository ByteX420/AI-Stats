name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: read

env:
    NODE_VERSION: 22

jobs:
    data:
        name: Validate data
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.15.1
                  run_install: false
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
                  cache-dependency-path: pnpm-lock.yaml

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Validate data files
              run: pnpm run validate:data && pnpm run validate:pricing && pnpm run validate:gateway

    check-paths:
        name: Check for data changes
        runs-on: ubuntu-latest
        if: github.event_name == 'push'
        outputs:
            data-changed: ${{ steps.filter.outputs.data }}
        steps:
            - uses: actions/checkout@v4

            - uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      data: 'apps/web/src/data/**'

    openapi-lint:
        name: OpenAPI lint
        runs-on: ubuntu-latest
        needs: data
        if: github.event_name == 'push' || !startsWith(github.head_ref, 'chore/auto-model-statuses')
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.15.1
                  run_install: false
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
                  cache-dependency-path: pnpm-lock.yaml

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Lint OpenAPI spec
              run: pnpm run openapi:lint

    apps:
        name: Apps ${{ matrix.app }}
        runs-on: ubuntu-latest
        needs: openapi-lint
        if: github.event_name == 'push' || !startsWith(github.head_ref, 'chore/auto-model-statuses')
        strategy:
            matrix:
                app: [api, docs, web]
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.15.1
                  run_install: false
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
                  cache-dependency-path: pnpm-lock.yaml

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: API lint & build
              if: matrix.app == 'api'
              run: |
                  pnpm run validate:api
                  cd apps/api && pnpm exec tsx scripts/pricing-simulator-cli.ts

            - name: Docs links
              if: matrix.app == 'docs'
              continue-on-error: true
              run: pnpm run docs:links

            - name: Web lint & typecheck
              if: matrix.app == 'web'
              continue-on-error: true
              run: |
                  cd apps/web
                  pnpm run lint
                  pnpm run typecheck

    importer:
        name: Run importer on main
        runs-on: ubuntu-latest
        needs:
            - data
            - check-paths
        if: needs.check-paths.outputs.data-changed == 'true' && github.ref == 'refs/heads/main'
        env:
            SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
            NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.15.1
                  run_install: false
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
                  cache-dependency-path: pnpm-lock.yaml

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run importer (all sections)
              if: ${{ env.SUPABASE_SERVICE_ROLE_KEY != '' && env.NEXT_PUBLIC_SUPABASE_URL != '' }}
              env:
                  SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
                  NEXT_PUBLIC_SUPABASE_URL: ${{ env.NEXT_PUBLIC_SUPABASE_URL }}
              run: cd apps/web && pnpm exec tsx scripts/importer/main.ts --section=all

    sdk-gen:
        name: Generate SDKs
        runs-on: ubuntu-latest
        needs: openapi-lint
        if: github.event_name == 'push' || !startsWith(github.head_ref, 'chore/auto-model-statuses')
        strategy:
            fail-fast: false
            matrix:
                include:
                    - sdk: ts
                      name: Generate TS SDK
                    - sdk: py
                      name: Generate PY SDK
                    - sdk: go
                      name: Generate GO SDK
                    - sdk: csharp
                      name: Generate C# SDK
                    - sdk: php
                      name: Generate PHP SDK
                    - sdk: ruby
                      name: Generate Ruby SDK
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.15.1
                  run_install: false
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
                  cache-dependency-path: pnpm-lock.yaml

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            # --- DEBUG: show generator versions ---
            - name: Debug generator versions
              run: |
                  echo "Node: $(node -v)"
                  echo "pnpm: $(pnpm -v)"
                  node -p "console.log('oapi-cli script =', JSON.parse(require('fs').readFileSync('package.json','utf8')).scripts['oapi'])" || true

            - name: Show openapi:gen scripts
              run: |
                  node -p "console.log('openapi:gen:ts =', JSON.parse(require('fs').readFileSync('package.json','utf8')).scripts['openapi:gen:ts'])" || true
                  node -p "console.log('openapi:gen:csharp =', JSON.parse(require('fs').readFileSync('package.json','utf8')).scripts['openapi:gen:csharp'])" || true

            # --- DEBUG: show key parts of the files *before* generation ---
            - name: Show TS ModerationRequestInput BEFORE
              if: matrix.sdk == 'ts'
              run: |
                  echo "==== TS ModerationRequestInput BEFORE ===="
                  sed -n '20,90p' packages/sdk/sdk-ts/src/oapi-gen/models/ModerationsRequestInput.ts || echo "File missing"

            # --- ACTUAL GENERATION ---
            - name: Generate ${{ matrix.sdk }} SDK
              run: |
                  case "${{ matrix.sdk }}" in
                    ts) pnpm run openapi:gen:ts ;;
                    py) pnpm run openapi:gen:py ;;
                    go) pnpm run openapi:gen:go ;;
                    csharp) pnpm run openapi:gen:csharp ;;
                    php) pnpm run openapi:gen:php ;;
                    ruby) pnpm run openapi:gen:ruby ;;
                  esac

            # --- DEBUG: show key parts of the files *after* generation ---
            - name: Show TS ModerationRequestInput AFTER
              if: matrix.sdk == 'ts'
              run: |
                  echo "==== TS ModerationRequestInput AFTER ===="
                  sed -n '20,90p' packages/sdk/sdk-ts/src/oapi-gen/models/ModerationsRequestInput.ts || echo "File missing"

            # --- EXISTING CONSISTENCY CHECK ---
            - name: Ensure OpenAPI outputs up to date
              run: |
                  case "${{ matrix.sdk }}" in
                    ts) gen_path="packages/sdk/sdk-ts/src/oapi-gen" ; gen_script="openapi:gen:ts" ;;
                    py) gen_path="packages/sdk/sdk-py/src/gen" ; gen_script="openapi:gen:py" ;;
                    go) gen_path="packages/sdk/sdk-go/src/gen" ; gen_script="openapi:gen:go" ;;
                    csharp) gen_path="packages/sdk/sdk-csharp/src/gen" ; gen_script="openapi:gen:csharp" ;;
                    php) gen_path="packages/sdk/sdk-php/src/gen" ; gen_script="openapi:gen:php" ;;
                    ruby) gen_path="packages/sdk/sdk-ruby/lib/gen" ; gen_script="openapi:gen:ruby" ;;
                  esac
                  echo "Checking that OpenAPI spec and '${{ matrix.sdk }}' SDK are up to date..."
                  if ! git diff --ignore-cr-at-eol --ignore-space-at-eol --quiet apps/docs/openapi/v1/openapi.yaml $gen_path; then
                    echo "::error::Detected *non-whitespace* differences in OpenAPI spec or generated '${{ matrix.sdk }}' SDK."
                    echo "::error::Please run 'pnpm run $gen_script' locally and commit the updated files."
                    echo ""
                    echo "Full diff:"
                    git diff apps/docs/openapi/v1/openapi.yaml $gen_path
                    exit 1
                  fi
                  echo "OpenAPI spec and '${{ matrix.sdk }}' SDK are in sync."

    packages:
        name: Build & test SDK packages
        runs-on: ubuntu-latest
        needs: sdk-gen
        if: github.event_name == 'push' || !startsWith(github.head_ref, 'chore/auto-model-statuses')
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python for SDK builds
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install Python build tooling
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install build pytest
                  python -m pip install -e packages/sdk/sdk-py

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.15.1
                  run_install: false
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
                  cache-dependency-path: pnpm-lock.yaml

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build SDKs
              run: pnpm run validate:packages

    deploy-preview-web:
        name: Deploy Web (Preview)
        runs-on: ubuntu-latest
        needs: apps
        if: github.event_name == 'pull_request' && !startsWith(github.head_ref, 'chore/auto-model-statuses')
        permissions:
            contents: read
            deployments: write
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.15.1
                  run_install: false
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
                  cache-dependency-path: pnpm-lock.yaml

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Install Vercel CLI
              run: npm install --global vercel@latest

            - name: Deploy web to Vercel (preview)
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              if: ${{ env.VERCEL_PROJECT_ID != '' }}
              run: |
                  vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
                  vercel build --token=$VERCEL_TOKEN
                  vercel deploy --prebuilt --archive=tgz --token=$VERCEL_TOKEN

    deploy:
        runs-on: ubuntu-latest
        needs:
            - apps
        if: github.ref == 'refs/heads/main'
        permissions:
            contents: write
            deployments: write
        strategy:
            matrix:
                include:
                    - target: web
                      name: Deploy Web
                    - target: api
                      name: Deploy API
                    - target: docs
                      name: Deploy Docs
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.15.1
                  run_install: false
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
                  cache-dependency-path: pnpm-lock.yaml

            # ---------- WEB (Vercel) ----------
            - name: Install dependencies
              if: matrix.target == 'web'
              run: pnpm install --frozen-lockfile

            - name: Install Vercel CLI
              if: matrix.target == 'web'
              run: npm install --global vercel@latest

            - name: Deploy web to Vercel (production)
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              if: ${{ matrix.target == 'web' && env.VERCEL_PROJECT_ID != '' }}
              run: |
                  vercel pull --yes --environment=production --token=$VERCEL_TOKEN
                  vercel build --prod --token=$VERCEL_TOKEN
                  vercel deploy --prebuilt --archive=tgz --prod --token=$VERCEL_TOKEN
            # ---------- API (Cloudflare Workers) ----------
            # Install deps so wrangler can resolve imports
            - name: Install dependencies (for API)
              if: matrix.target == 'api'
              run: pnpm install --frozen-lockfile

            # Wrangler CLI (you already had this)
            - name: Install Wrangler CLI
              if: matrix.target == 'api'
              run: npm install -g wrangler@4.45.0

            - name: Deploy API app to Cloudflare
              if: matrix.target == 'api'
              uses: cloudflare/wrangler-action@v3
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  workingDirectory: apps/api

            # ---------- DOCS ----------
            - name: Docs (Mintlify deploy is handled by GitHub App)
              if: matrix.target == 'docs'
              run: echo "Mintlify picks up main branch changes and deploys docs automatically."

    publish:
        name: Handle Versions
        runs-on: ubuntu-latest
        needs:
            - sdk-gen
            - packages
            - apps
        if: github.ref == 'refs/heads/main'
        permissions:
            contents: write
            pull-requests: write
            id-token: write
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Create GitHub App token (AI Stats Bot)
              id: app-token
              uses: actions/create-github-app-token@v2
              with:
                  app-id: ${{ secrets.AI_STATS_APP_ID }}
                  private-key: ${{ secrets.AI_STATS_APP_PRIVATE_KEY }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.15.1
                  run_install: false
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm
                  cache-dependency-path: pnpm-lock.yaml

            - name: Upgrade npm (for trusted publishing)
              run: |
                  npm install -g npm@latest
                  node -v
                  npm -v

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Create release PR / publish
              id: changesets
              uses: changesets/action@v1
              with:
                  version: pnpm run changeset:version
                  publish: pnpm run changeset:publish
                  createGithubReleases: false
                  commitMode: github-api
              env:
                  GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

            - name: Set up Python (for PyPI publish)
              if: github.ref == 'refs/heads/main'
              uses: actions/setup-python@v5
              with:
                  python-version: 3.12

            - name: Build Python SDK
              if: github.ref == 'refs/heads/main'
              working-directory: packages/sdk/sdk-py
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install build
                  python -m build

            - name: Publish Python SDK to PyPI (Trusted Publishing)
              if: github.ref == 'refs/heads/main'
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: packages/sdk/sdk-py/dist
                  skip-existing: true

            - name: Create GitHub releases from changelogs
              if: steps.changesets.outputs.published == 'true'
              env:
                  GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  pnpm run release-from-changelogs

